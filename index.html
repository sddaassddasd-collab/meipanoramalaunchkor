<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>meipanorama</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css">
<style>
  html,body{height:100%;margin:0;background:#0f172a;color:#e2e8f0;
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","Helvetica Neue",Arial,sans-serif}
  #panorama{position:absolute;inset:0;z-index:0}

  /* ä¸­å¤®äººç‰© */
  .character {
    position:fixed;
    top:70%; left:50%;
    transform:translate(-50%,-50%);
    z-index:20;
    pointer-events:none;
  }
  .hidden{ display:none; }
  #body {max-width:160px;display:none;}
  #head {position:absolute;top:-110px;left:50%;transform:translateX(-50%);max-width:120px;display:none;}

  /* åœ‹æ—— */
  .flag{
    position:fixed;top:50%;right:12px;transform:translateY(-50%);
    z-index:20;pointer-events:none;
  }
  .flag img{height:64px;width:auto;display:block}

  /* åº•éƒ¨æ§åˆ¶é¢æ¿ */
  .controls{
    position:fixed;left:0;right:0;bottom:0;
    background:rgba(15,23,42,.9);backdrop-filter:blur(6px);
    border-top:1px solid rgba(148,163,184,.3);
    max-height:40%;overflow-y:auto;
    transition:transform 0.3s ease;
    z-index:40;padding:10px;
  }
  .controls.collapsed{ transform:translateY(calc(100% - 30px)); }
  .controls h3{margin:6px 0;font-size:13px;color:#cbd5e1}
  .options{display:flex;flex-wrap:wrap;gap:6px}
  .options button{
    padding:4px 6px;border:none;border-radius:6px;background:#334155;color:#fff;
    cursor:pointer;font-size:13px
  }
  .options button:hover{background:#3b82f6}
  .toggle-btn{
    position:absolute;right:10px;top:5px;
    background:rgba(59,130,246,.8);color:#fff;
    border:none;border-radius:6px;padding:2px 8px;
    cursor:pointer;font-size:12px
  }
  .toggle-btn:hover{background:rgba(37,99,235,.95)}

  /* æ‹ç…§èˆ‡é è¦½ */
  .btn{position:fixed;right:12px;bottom:60px;padding:8px 12px;background:rgba(30,41,59,.85);color:#fff;border:none;border-radius:10px;cursor:pointer;z-index:30}
  .btn:hover{background:rgba(59,130,246,.9)}
  .badge{position:fixed;left:12px;bottom:12px;background:rgba(15,23,42,.6);border:1px solid rgba(148,163,184,.25);padding:6px 8px;border-radius:10px;font-size:12px;opacity:.85;z-index:30}
  .badge[hidden]{display:none}
  .preview{position:fixed;right:12px;bottom:120px;width:280px;background:rgba(15,23,42,.95);border:1px solid rgba(148,163,184,.25);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35);display:none;overflow:hidden;backdrop-filter:blur(6px);z-index:50}
  .preview-header{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-bottom:1px solid rgba(148,163,184,.2);font-size:13px}
  .preview-body{padding:10px}
  .preview-img{width:100%;aspect-ratio:16/9;object-fit:cover;border-radius:10px;background:#111827}
  .preview-actions{display:flex;gap:8px;padding:10px}
  .btn-ghost,.btn-primary{flex:1;padding:8px 10px;border:none;border-radius:10px;cursor:pointer}
  .btn-ghost{background:rgba(51,65,85,.85);color:#e5e7eb}
  .btn-ghost:hover{background:rgba(71,85,105,.9)}
  .btn-primary{background:rgba(59,130,246,.9);color:#fff;text-align:center;text-decoration:none}
  .btn-primary:hover{background:rgba(37,99,235,.95)}
  .close-x{appearance:none;border:none;background:transparent;color:#94a3b8;font-size:18px;line-height:1;cursor:pointer;padding:2px 6px;border-radius:6px}
  .close-x:hover{background:rgba(148,163,184,.15);color:#e2e8f0}

  /* å·¦ä¸Šè§’ End æŒ‰éˆ• */
  .exit-btn{
    position:fixed;top:10px;left:10px;
    z-index:1000;
    display:inline-flex;align-items:center;gap:6px;
    padding:8px 12px;border:1px solid rgba(148,163,184,.35);
    border-radius:10px;background:rgba(15,23,42,.85);
    color:#e2e8f0;cursor:pointer;font-weight:600;font-size:14px;
    backdrop-filter: blur(6px);
  }
  .exit-btn:hover{background:rgba(30,41,59,.95);}
  .exit-btn .x{font-size:16px;line-height:1;opacity:.9}
</style>
</head>
<body>
  <!-- éŸ³æ¨‚ -->
  <audio id="bgAudio" src="audio.mp3" autoplay></audio>

  <!-- panorama -->
  <div id="panorama"></div>

  <!-- å·¦ä¸Šè§’ End -->
  <button id="exitBtn" class="exit-btn" aria-label="End and leave">
    <span class="x">Ã—</span> End
  </button>
  <a id="exitFallback"
     href="https://sddaassddasd-collab.github.io/theinvinciblecityending/"
     target="_top" rel="noopener"
     style="display:none">fallback</a>

  <!-- äººç‰© -->
  <div class="character hidden" id="character">
    <img id="body" alt="body">
    <img id="head" alt="head">
  </div>

  <!-- åœ‹æ—— -->
  <div class="flag" id="flag"><img id="flagImg" src="./images/flag1.png" alt="flag"></div>

  <!-- æ§åˆ¶é¢æ¿ -->
  <div class="controls collapsed" id="controls">
    <button class="toggle-btn" id="toggleBtn">â–² ìŠ¤íƒ€ì¼ ì„ íƒ | Choose outfit</button>
    <div>
      <h3>ë¨¸ë¦¬ | Head</h3>
      <div class="options" id="headOptions"></div>
    </div>
    <div>
      <h3>ëª¸ | Body</h3>
      <div class="options" id="bodyOptions"></div>
    </div>
    <div>
      <h3>êµ­ê¸° | Flag</h3>
      <div class="options" id="flagOptions"></div>
    </div>
  </div>

  <!-- æ‹ç…§èˆ‡é è¦½ -->
  <div id="statusBadge" class="badge" hidden>ë¡œë”© ì¤‘â€¦ | Loadingâ€¦</div>
  <button id="captureBtn" class="btn">ğŸ“· ì´¬ì˜ | Capture</button>

  <div id="previewCard" class="preview" aria-live="polite">
    <div class="preview-header">
      <div>ì´¬ì˜ ë¯¸ë¦¬ë³´ê¸° | Preview</div>
      <button id="closePreview" class="close-x" title="ë‹«ê¸° | Close">âœ•</button>
    </div>
    <div class="preview-body">
      <img id="previewImg" class="preview-img" alt="ì´¬ì˜ ë¯¸ë¦¬ë³´ê¸° | Capture preview">
    </div>
    <div class="preview-actions">
      <button id="retakeBtn" class="btn-ghost">ë‹«ê¸° | Close</button>
      <a id="downloadBtn" class="btn-primary" download>ë‹¤ìš´ë¡œë“œ | Download</a>
    </div>
  </div>

  <!-- ä¿ç•™ WebGL buffer -->
  <script>
    (function monkeyPatchPreserveDrawingBuffer(){
      const orig = HTMLCanvasElement.prototype.getContext;
      HTMLCanvasElement.prototype.getContext = function(type, attrs){
        if (type === 'webgl' || type === 'experimental-webgl') {
          attrs = Object.assign({}, attrs, { preserveDrawingBuffer: true });
        }
        return orig.call(this, type, attrs);
      };
    })();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>
  <script>
    const viewer = pannellum.viewer('panorama', {
      type: 'equirectangular',
      panorama: 'panorama_mei.jpg',
      autoLoad: true,
      showZoomCtrl: true,
      showFullscreenCtrl: true,
      hfov: 100, minHfov: 50, maxHfov: 120,
      pitch: 0, yaw: 0,
      backgroundColor: [15,23,42]
    });

    window.addEventListener('DOMContentLoaded', () => {
      const audio = document.getElementById('bgAudio');
      audio.play().catch(err=>{
        const btn=document.createElement('button');
        btn.textContent="â–¶ ìŒì•… ì¬ìƒ | Play music";
        Object.assign(btn.style,{
          position:'fixed',top:'50%',left:'50%',transform:'translate(-50%,-50%)',
          zIndex:2000,padding:'12px 20px',fontSize:'18px',background:'rgba(30,41,59,0.9)',
          color:'#fff',border:'none',borderRadius:'10px',cursor:'pointer',
          boxShadow:'0 6px 20px rgba(0,0,0,.4)'
        });
        document.body.appendChild(btn);
        btn.addEventListener('click',()=>{audio.play();btn.remove();});
      });
    });

    const headImages = Array.from({length:6},(_,i)=>`./images/head${i+1}.png`);
    const bodyImages = Array.from({length:10},(_,i)=>`./images/body${i+1}.png`);
    const flagEmojis=["ğŸ‡¹ğŸ‡¼","ğŸ‡°ğŸ‡·","ğŸ‡»ğŸ‡³","ğŸ‡­ğŸ‡°","ğŸ‡¨ğŸ‡³","ğŸ‡²ğŸ‡¾","ğŸ‡¯ğŸ‡µ","ğŸ‡©ğŸ‡ª","ğŸ‡ºğŸ‡¸","ğŸ‡¬ğŸ‡§"];
    const flagPngs=Array.from({length:11},(_,i)=>`./images/flag${i+1}.png`);

    const panoEl=document.getElementById('panorama');
    const headEl=document.getElementById('head');
    const bodyEl=document.getElementById('body');
    const flagImgEl=document.getElementById('flagImg');
    const characterEl=document.getElementById('character');
    const headBox=document.getElementById('headOptions');
    const bodyBox=document.getElementById('bodyOptions');
    const flagBox=document.getElementById('flagOptions');
    const controls=document.getElementById('controls');
    const toggleBtn=document.getElementById('toggleBtn');
    const badge=document.getElementById('statusBadge');
    const captureBtn=document.getElementById('captureBtn');
    const previewCard=document.getElementById('previewCard');
    const previewImg=document.getElementById('previewImg');
    const closeBtn=document.getElementById('closePreview');
    const retakeBtn=document.getElementById('retakeBtn');
    const downloadBtn=document.getElementById('downloadBtn');
    let currentBlobUrl=null,ready=false;
    viewer.on('load',()=>{ready=true;});

    function setBadge(t,show=true){badge.textContent=t;badge.hidden=!show;}
    function showPreviewWithBlob(blob){
      if(currentBlobUrl)URL.revokeObjectURL(currentBlobUrl);
      currentBlobUrl=URL.createObjectURL(blob);
      previewImg.src=currentBlobUrl;
      const ts=new Date().toISOString().replace(/[:.]/g,'-');
      downloadBtn.href=currentBlobUrl;
      downloadBtn.download=`panorama_capture_${ts}.png`;
      previewCard.style.display='block';
    }
    function hidePreview(){
      previewCard.style.display='none';
      if(currentBlobUrl)URL.revokeObjectURL(currentBlobUrl);
      currentBlobUrl=null;
      previewImg.removeAttribute('src');
      downloadBtn.removeAttribute('href');
    }
    function revealCharacter(){characterEl.classList.remove('hidden');}
    function renderImageOptions(box,items,targetEl){
      items.forEach((src,i)=>{
        const b=document.createElement('button');
        b.textContent=i+1;
        b.onclick=()=>{targetEl.src=src;targetEl.style.display='block';revealCharacter();};
        box.appendChild(b);
      });
    }
    function renderFlagOptions(box,emojiList,pngList,target){
      emojiList.forEach((e,i)=>{
        const b=document.createElement('button');
        b.textContent=e;
        b.onclick=()=>{target.src=pngList[i];};
        box.appendChild(b);
      });
    }
    renderImageOptions(headBox,headImages,headEl);
    renderImageOptions(bodyBox,bodyImages,bodyEl);
    renderFlagOptions(flagBox,flagEmojis,flagPngs,flagImgEl);

    toggleBtn.onclick=()=>{
      controls.classList.toggle('collapsed');
      toggleBtn.textContent=controls.classList.contains('collapsed')
        ? 'â–² ìŠ¤íƒ€ì¼ ì„ íƒ | Choose outfit'
        : 'â–¼ ì°½ ë‹«ê¸° | Close panel';
    };

    async function captureComposite(){
      const r=viewer.getRenderer?.(); if(!r||!r.getCanvas)throw new Error('Unable to get renderer/canvas');
      const glCanvas=r.getCanvas(); const gl=glCanvas.getContext('webgl')||glCanvas.getContext('experimental-webgl');
      if(!gl)throw new Error('No WebGL context');
      const W=glCanvas.width,H=glCanvas.height; if(!W||!H)throw new Error('Canvas size 0');
      const oldYaw=viewer.getYaw(); viewer.setYaw(oldYaw+0.0001); r.render?.(); viewer.setYaw(oldYaw);
      await new Promise(requestAnimationFrame);
      const pixels=new Uint8Array(W*H*4); gl.readPixels(0,0,W,H,gl.RGBA,gl.UNSIGNED_BYTE,pixels);
      const out=document.createElement('canvas'); out.width=W; out.height=H;
      const ctx=out.getContext('2d'); const imgData=ctx.createImageData(W,H);
      for(let y=0;y<H;y++){const s=H-1-y; imgData.data.set(pixels.subarray(s*W*4,(s+1)*W*4),y*W*4);}
      ctx.putImageData(imgData,0,0);
      const dpr=window.devicePixelRatio||1; const panoRect=panoEl.getBoundingClientRect();
      function drawImg(el){if(!el||!el.complete||!el.src)return;const r=el.getBoundingClientRect();
        const x=(r.left-panoRect.left)*dpr,y=(r.top-panoRect.top)*dpr,w=r.width*dpr,h=r.height*dpr;
        if(w>0&&h>0)ctx.drawImage(el,x,y,w,h);}
      drawImg(bodyEl);drawImg(headEl);drawImg(flagImgEl);
      return await new Promise(res=>out.toBlob(res,'image/png'));
    }

    captureBtn.onclick=async()=>{
      try{
        if(!ready){setBadge('ë¡œë”© ì¤‘â€¦ | Loadingâ€¦',true);return;}
        setBadge('ìº¡ì²˜ ì¤‘â€¦ | Capturingâ€¦',true);
        const blob=await captureComposite();
        showPreviewWithBlob(blob);
        setBadge('ìº¡ì²˜ ì™„ë£Œ | Captured',true);
        setTimeout(()=>setBadge('',false),800);
      }catch(err){setBadge('',false);alert('ì´¬ì˜ ì‹¤íŒ¨: '+err.message);}
    };
    closeBtn.onclick=hidePreview;
    retakeBtn.onclick=hidePreview;

  /* End æŒ‰éˆ•è¡Œç‚º */
(function(){
  const TARGET = "https://sddaassddasd-collab.github.io/theinvinciblecityending/";
  const btn = document.getElementById('exitBtn');
  const fallback = document.getElementById('exitFallback');

  btn.addEventListener('click', e => {
    e.preventDefault();
    try {
      // å˜—è©¦ç”¨ window.open ä»¥ä½¿ç”¨è€…æ‰‹å‹¢é–‹å•Ÿæ–°åˆ†é 
      const w = window.open(TARGET, 'finale', 'popup,width=900,height=700');

      // è‹¥ç€è¦½å™¨é˜»æ“‹ popupï¼Œå‰‡ä½¿ç”¨å‚™æ´é€£çµ
      if (!w || w.closed || typeof w.closed === 'undefined') {
        window.top.location.href = TARGET;
      }
    } catch (err) {
      console.warn("Open blocked:", err);
      window.top.location.href = TARGET;
    }
  });
})();

  </script>
</body>
</html>
