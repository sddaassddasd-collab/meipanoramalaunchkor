<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>meipanorama</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css">
<style>
  html,body{height:100%;margin:0;background:#0f172a;color:#e2e8f0;
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","Helvetica Neue",Arial,sans-serif}
  #panorama{position:absolute;inset:0;z-index:0}

  /* 中央人物（頭和身體疊合） */
  .character {
    position:fixed;
    top:70%; left:50%;
    transform:translate(-50%,-50%);
    z-index:20;
    pointer-events:none;
  }
  #body {
    max-width:160px; /* 身體大小 */
  }
  #head {
    position:absolute;
    top:-110px;       /* 頭與身體的距離，可調整 */
    left:50%;
    transform:translateX(-50%);
    max-width:120px; /* 頭大小 */
  }

  /* 右側國旗（會被合成） */
  .flag{
    position:fixed;top:50%;right:12px;transform:translateY(-50%);
    z-index:20;pointer-events:none;
  }
  .flag img{height:64px;width:auto;display:block}

  /* 底部控制面板 */
  .controls{
    position:fixed;left:0;right:0;bottom:0;
    background:rgba(15,23,42,.9);backdrop-filter:blur(6px);
    border-top:1px solid rgba(148,163,184,.3);
    max-height:40%;overflow-y:auto;
    transition:transform 0.3s ease;
    z-index:40;padding:10px;
  }
  .controls.collapsed{ transform:translateY(calc(100% - 30px)); }
  .controls h3{margin:6px 0;font-size:13px;color:#cbd5e1}
  .options{display:flex;flex-wrap:wrap;gap:6px}
  .options button{
    padding:4px 6px;border:none;border-radius:6px;background:#334155;color:#fff;
    cursor:pointer;font-size:13px
  }
  .options button:hover{background:#3b82f6}
  .toggle-btn{
    position:absolute;right:10px;top:5px;
    background:rgba(59,130,246,.8);color:#fff;
    border:none;border-radius:6px;padding:2px 8px;
    cursor:pointer;font-size:12px
  }
  .toggle-btn:hover{background:rgba(37,99,235,.95)}

  /* 拍照按鈕與預覽卡 */
  .btn{position:fixed;right:12px;bottom:60px;padding:8px 12px;background:rgba(30,41,59,.85);color:#fff;border:none;border-radius:10px;cursor:pointer;z-index:30}
  .btn:hover{background:rgba(59,130,246,.9)}
  .badge{position:fixed;left:12px;bottom:12px;background:rgba(15,23,42,.6);border:1px solid rgba(148,163,184,.25);padding:6px 8px;border-radius:10px;font-size:12px;opacity:.85;z-index:30}
  .badge[hidden]{display:none}
  .preview{position:fixed;right:12px;bottom:120px;width:280px;background:rgba(15,23,42,.95);border:1px solid rgba(148,163,184,.25);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35);display:none;overflow:hidden;backdrop-filter:blur(6px);z-index:50}
  .preview-header{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-bottom:1px solid rgba(148,163,184,.2);font-size:13px}
  .preview-body{padding:10px}
  .preview-img{width:100%;aspect-ratio:16/9;object-fit:cover;border-radius:10px;background:#111827}
  .preview-actions{display:flex;gap:8px;padding:10px}
  .btn-ghost,.btn-primary{flex:1;padding:8px 10px;border:none;border-radius:10px;cursor:pointer}
  .btn-ghost{background:rgba(51,65,85,.85);color:#e5e7eb}
  .btn-ghost:hover{background:rgba(71,85,105,.9)}
  .btn-primary{background:rgba(59,130,246,.9);color:#fff;text-align:center;text-decoration:none}
  .btn-primary:hover{background:rgba(37,99,235,.95)}
  .close-x{appearance:none;border:none;background:transparent;color:#94a3b8;font-size:18px;line-height:1;cursor:pointer;padding:2px 6px;border-radius:6px}
  .close-x:hover{background:rgba(148,163,184,.15);color:#e2e8f0}
</style>
</head>
<body>
  <!-- 自動播放音樂（無 loop） -->
  <audio id="bgAudio" src="audio.mp3" autoplay></audio>

  <div id="panorama"></div>

  <!-- 人物 -->
  <div class="character" id="character">
    <img id="body" src="./images/body1.png" alt="body">
    <img id="head" src="./images/head1.png" alt="head">
  </div>

  <!-- 國旗 -->
  <div class="flag" id="flag"><img id="flagImg" src="./images/flag1.png" alt="flag"></div>

  <!-- 底部控制面板 -->
  <div class="controls collapsed" id="controls">
    <button class="toggle-btn" id="toggleBtn">▲ 스타일 선택 | Choose outfit</button>
    <div>
      <h3>머리 | Head</h3>
      <div class="options" id="headOptions"></div>
    </div>
    <div>
      <h3>몸 | Body</h3>
      <div class="options" id="bodyOptions"></div>
    </div>
    <div>
      <h3>국기 | Flag</h3>
      <div class="options" id="flagOptions"></div>
    </div>
  </div>

  <!-- 狀態/拍照/預覽 -->
  <div id="statusBadge" class="badge" hidden>로딩 중… | Loading…</div>
  <button id="captureBtn" class="btn">📷 촬영 | Capture</button>

  <div id="previewCard" class="preview" aria-live="polite">
    <div class="preview-header">
      <div>촬영 미리보기 | Preview</div>
      <button id="closePreview" class="close-x" title="닫기 | Close">✕</button>
    </div>
    <div class="preview-body">
      <img id="previewImg" class="preview-img" alt="촬영 미리보기 | Capture preview">
    </div>
    <div class="preview-actions">
      <button id="retakeBtn" class="btn-ghost">닫기 | Close</button>
      <a id="downloadBtn" class="btn-primary" download>다운로드 | Download</a>
    </div>
  </div>

  <!-- WebGL preserve -->
  <script>
    (function monkeyPatchPreserveDrawingBuffer(){
      const orig = HTMLCanvasElement.prototype.getContext;
      HTMLCanvasElement.prototype.getContext = function(type, attrs){
        if (type === 'webgl' || type === 'experimental-webgl') {
          attrs = Object.assign({}, attrs, { preserveDrawingBuffer: true });
        }
        return orig.call(this, type, attrs);
      };
    })();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>
  <script>
    // ===== 初始化 Pannellum =====
    const viewer = pannellum.viewer('panorama', {
      type: 'equirectangular',
      panorama: 'panorama_mei.jpg', 
      autoLoad: true,
      showZoomCtrl: true,
      showFullscreenCtrl: true,
      hfov: 100, minHfov: 50, maxHfov: 120,
      pitch: 0, yaw: 0,
      backgroundColor: [15, 23, 42]
    });

    // ===== 音樂自動播放 fallback =====
    window.addEventListener('DOMContentLoaded', () => {
      const audio = document.getElementById('bgAudio');
      audio.play().catch(err => {
        console.warn('自動播放失敗，需要互動：', err);
        const btn = document.createElement('button');
        btn.textContent = "▶ 음악 재생 | Play music";
        btn.style.position = 'fixed';
        btn.style.top = '50%';
        btn.style.left = '50%';
        btn.style.transform = 'translate(-50%, -50%)';
        btn.style.zIndex = 2000;
        btn.style.padding = '12px 20px';
        btn.style.fontSize = '18px';
        btn.style.background = 'rgba(30,41,59,0.9)';
        btn.style.color = '#fff';
        btn.style.border = 'none';
        btn.style.borderRadius = '10px';
        btn.style.cursor = 'pointer';
        btn.style.boxShadow = '0 6px 20px rgba(0,0,0,.4)';
        document.body.appendChild(btn);
        btn.addEventListener('click', () => {
          audio.play();
          btn.remove();
        });
      });
    });

    // ===== 頭/身體圖片、國旗對應表 =====
    const headImages = Array.from({length: 6}, (_,i)=>`./images/head${i+1}.png`);
    const bodyImages = Array.from({length: 10}, (_,i)=>`./images/body${i+1}.png`);

    const flagEmojis = ["🇹🇼","🇰🇷","🇻🇳","🇭🇰","🇨🇳","🇲🇾","🇯🇵","🇩🇪","🇺🇸","🇬🇧"];
    const flagPngs   = Array.from({length: 11}, (_,i)=>`./images/flag${i+1}.png`);

    const panoEl = document.getElementById('panorama');
    const headEl = document.getElementById('head');
    const bodyEl = document.getElementById('body');
    const flagImgEl = document.getElementById('flagImg');

    const headBox = document.getElementById('headOptions');
    const bodyBox = document.getElementById('bodyOptions');
    const flagBox = document.getElementById('flagOptions');

    const controls = document.getElementById('controls');
    const toggleBtn = document.getElementById('toggleBtn');

    const badge = document.getElementById('statusBadge');
    const captureBtn  = document.getElementById('captureBtn');
    const previewCard = document.getElementById('previewCard');
    const previewImg  = document.getElementById('previewImg');
    const closeBtn    = document.getElementById('closePreview');
    const retakeBtn   = document.getElementById('retakeBtn');
    const downloadBtn = document.getElementById('downloadBtn');

    let currentBlobUrl = null;
    let ready = false;
    viewer.on('load', ()=>{ ready = true; });

    function setBadge(text, show=true){ badge.textContent = text; badge.hidden = !show; }
    function showPreviewWithBlob(blob){
      if (currentBlobUrl) URL.revokeObjectURL(currentBlobUrl);
      currentBlobUrl = URL.createObjectURL(blob);
      previewImg.src = currentBlobUrl;
      const ts = new Date().toISOString().replace(/[:.]/g,'-');
      downloadBtn.href = currentBlobUrl;
      downloadBtn.download = `panorama_capture_${ts}.png`;
      previewCard.style.display = 'block';
    }
    function hidePreview(){
      previewCard.style.display = 'none';
      if (currentBlobUrl) URL.revokeObjectURL(currentBlobUrl);
      currentBlobUrl = null;
      previewImg.removeAttribute('src');
      downloadBtn.removeAttribute('href');
    }

    function renderImageOptions(box, items, targetEl){
      items.forEach((src, idx)=>{
        const btn = document.createElement('button');
        btn.textContent = idx+1;
        btn.addEventListener('click', ()=>{ targetEl.src = src; });
        box.appendChild(btn);
      });
    }
    function renderFlagOptions(box, emojiList, pngList, targetImgEl){
      emojiList.forEach((emoji, idx)=>{
        const btn = document.createElement('button');
        btn.textContent = emoji;
        btn.addEventListener('click', ()=>{ targetImgEl.src = pngList[idx]; });
        box.appendChild(btn);
      });
    }
    renderImageOptions(headBox, headImages, headEl);
    renderImageOptions(bodyBox, bodyImages, bodyEl);
    renderFlagOptions(flagBox, flagEmojis, flagPngs, flagImgEl);

    toggleBtn.addEventListener('click', ()=>{
      controls.classList.toggle('collapsed');
      toggleBtn.textContent = controls.classList.contains('collapsed')
        ? '▲ 스타일 선택 | Choose outfit'
        : '▼ 창 닫기 | Close panel';
    });

    // ===== 合成截圖 =====
    async function captureComposite(){
      const r = viewer.getRenderer?.();
      if (!r || !r.getCanvas) throw new Error('렌더러/캔버스를 가져올 수 없습니다 | Unable to get renderer/canvas');
      const glCanvas = r.getCanvas();
      const gl = glCanvas.getContext('webgl') || glCanvas.getContext('experimental-webgl');
      if (!gl) throw new Error('WebGL 컨텍스트가 없습니다 | No WebGL context');

      const W = glCanvas.width, H = glCanvas.height;
      if (!W || !H) throw new Error('캔버스 크기가 0입니다 | Canvas size is 0');

      const oldYaw = viewer.getYaw();
      viewer.setYaw(oldYaw + 0.0001);
      r.render?.();
      viewer.setYaw(oldYaw);
      await new Promise(requestAnimationFrame);

      const pixels = new Uint8Array(W * H * 4);
      gl.readPixels(0, 0, W, H, gl.RGBA, gl.UNSIGNED_BYTE, pixels);

      const out = document.createElement('canvas');
      out.width = W; out.height = H;
      const ctx = out.getContext('2d');
      const imgData = ctx.createImageData(W, H);
      for (let y = 0; y < H; y++) {
        const srcRow = H - 1 - y;
        imgData.data.set(
          pixels.subarray(srcRow * W * 4, (srcRow + 1) * W * 4),
          y * W * 4
        );
      }
      ctx.putImageData(imgData, 0, 0);

      const dpr = window.devicePixelRatio || 1;
      const panoRect = panoEl.getBoundingClientRect();
      function drawImgAtElement(imgEl){
        if (!imgEl.complete) return;
        const rEl = imgEl.getBoundingClientRect();
        const x = (rEl.left - panoRect.left) * dpr;
        const y = (rEl.top  - panoRect.top)  * dpr;
        const w = rEl.width  * dpr;
        const h = rEl.height * dpr;
        if (w>0 && h>0) ctx.drawImage(imgEl, x, y, w, h);
      }

      drawImgAtElement(bodyEl);
      drawImgAtElement(headEl);
      drawImgAtElement(flagImgEl);

      const blob = await new Promise(res => out.toBlob(res, 'image/png'));
      return blob;
    }

    captureBtn.addEventListener('click', async ()=>{
      try{
        if (!ready){ setBadge('로딩 중… | Loading…', true); return; }
        setBadge('캡처 중… | Capturing…', true);
        const blob = await captureComposite();
        showPreviewWithBlob(blob);
        setBadge('캡처 완료 | Captured', true);
        setTimeout(()=>setBadge('', false), 800);
      }catch(err){
        setBadge('', false);
        alert('촬영 실패 (Capture failed): ' + (err && err.message ? err.message : err));
      }
    });

    closeBtn.addEventListener('click', hidePreview);
    retakeBtn.addEventListener('click', hidePreview);
  </script>
</body>
</html>